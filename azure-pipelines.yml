# Starter pipeline
# Start with a minimal pipeline that you can customize to build and deploy your code.
# Add steps that build, run tests, deploy, and more:
# https://aka.ms/yaml


name: loan test pipeline

## this configuration is ignored since the pipeline is already connected to github
## and there is already a step checkout to clone script from github under 'steps'
# resources: 
#   repositories:
#   - repository: Regression-api-web-combination-sample
#     type: github
#     ref: refs/heads/master
#     name: kms-loantran/Regression-api-web-combination-sample
#     endpoint: github/kms-loantran

trigger:
  - master

pool:
  vmImage: windows-latest

stages:
- stage: Test
  displayName: Run Automation script
  jobs:
  - job: TestOnWindows
    displayName: Run automation script on Windows
    continueOnError: true
    variables:  # job-level
      VERSION: '8.0.0'
      TMP_DIR: $(Build.ArtifactStagingDirectory)
    steps:
    - checkout: self
      clean: true
      fetchDepth: 1
    # - bash: |
    #     curl "https://download.katalon.com/${VERSION}/Katalon_Studio_Engine_Windows_64-${VERSION}.zip" -o "katalon_runtime_engine.zip"
    #   displayName: download KRE package
    # - bash: 
    #     unzip katalon_runtime_engine.zip
    #   displayName: unzip KRE package
    - task: S3Download@1
      inputs:
        awsCredentials: 'aws'
        regionName: 'us-east-1'
        bucketName: 'katalon'
        sourceFolder: '$(VERSION)'
        globExpressions: '@(Katalon_Studio_Windows_64|Katalon_Studio_Engine_Windows_64)*.zip'
        targetFolder: '$(TMP_DIR)'
      displayName: Download KSE and KRE
      # condition: startsWith(variables.RUN_TESTS, 'true')
    - bash: |
        set -xe
        cd ${TMP_DIR}/${VERSION}
        unzip Katalon_Studio_Windows_64-${VERSION}.zip
        unzip Katalon_Studio_Engine_Windows_64-${VERSION}.zip
      displayName: Extract KSR and KRE
      # condition: startsWith(variables.RUN_TESTS, 'true')
    - script: Katalon_Studio_Engine_Windows_64-8.0.0\katalonc -noSplash -runMode=console -projectPath="Regression-api-web-combination-sample\Sample Jira ticket creation.prj" -retry=0 -testSuitePath="Test Suites/Create and update a task by both API and UI" -browserType="Chrome" -apiKey="f94fd9eb-459b-4115-8980-e632fb614490"


